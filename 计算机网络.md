# OSI七层模型

- 应用层
- 表示层
- 会话层
- 传输层
- 网络层
- 数据链路层
- 物理层

## 1.应用层

用户与网络的界面

典型应用层服务:

- 文件传输(FTP)
- 电子邮件(FMTP)
- 万维网(HTTP)

## 2.表示层

用于处理在两个通信系统中交换信息的方式，包含JPEG、ASCII等

- 数据格式变换
- 数据加/解密
- 数据压缩与恢复

## 3.会话层

向表示层实体/用户进程提供建立连接并在连接上有序地传输数据。这是会话，也是建立同步(SYN)

- 建立、管理、终止会话
- 使用校验点可使会话在通信失效时从==校验点/同步点==继续恢复通信，实现数据同步(传输大文件)

## 4.传输层

负责主机当中==两个进程==的通信，即==端到端==的通信，传输单位是报文段或者

用户数据报(TCP、UDP)

- 可靠传输、不可靠传输
- 差错控制
- 流量控制 
- 复用分用

## 5.网络层

把分组从源端传到目的端，为分组交换网上的不同主机提供通信服务

IP、IPX、ICMP、IGMP、ARP、RARP、OSPF

- 路由选择
- 流量控制
- 差错控制
- 拥塞控制

## 6.数据链路层

把网络层传下来的数据包组装成帧

SDLC、HDLC、PPP、STP

- 成帧(定义帧的开始和结束)   ....1000011101010101....
- 差错控制  帧错或位错
- 流量控制
- 访问(接入)控制 控制对信道的访问

## 7.物理层

在物理媒体上实现比特流的透明传输

- 定义接口特性
- 定义传输模式(单工、半双工、双工)
- 定义传输速率
- 比特同步
- 比特编码



# 5层参考模型

综合了OSI和TCP/IP的优点

- 应用层 --- 支持各种网络应用 FTP、SMTP、HTTP
- 传输层 --- 进程-进程的数据传输 TCP、UDP
- 网络层 --- 源主机到目的主机的数据分组路由与转发 IP、ICMP、OSPF
- 数据链路层 --- 把网络层传下来的数据报组装成帧 Ethernet、PPP
- 物理层 --- 比特传输



# TCP

## 三次握手

效果表示了为什么不是2次握手

|      | 过程                                                        | 效果                                                       |
| ---- | ----------------------------------------------------------- | ---------------------------------------------------------- |
| 1    | **客户端**向服务端发送SYN(Seq=X)标志的数据包==>**服务端**   | **服务端**确认自己接收正常，**客户端**发送正常             |
| 2    | **服务端**发送带有SYN(Seq=y),ACK = 1,ack = x+1==>**客户端** | **客户端**确认自己发送、接收正常，**服务端**发送、接收正常 |
| 3    | **客户端**发送ACK=1，ack=y+1==>**服务端**接收到后完成       | **服务端**确认自己发送、接收正常，**服务端**发送、接收正常 |

SYN 同步序列编号(Synchronize Sequence Numbers) 是 TCP/IP 建立连接时使用的握手信号。

##  四次挥手
1. 客户端发送一个 FIN（SEQ=X） 标志的数据包==>服务端，用来关闭客户端到服务器的数据传送。
2. 服务器收到这个 FIN（SEQ=X） 标志的数据包，它发送一个 ACK （SEQ=X+1）标志的数据包==>客户端 。
3. 服务端关闭与客户端的连接，并发送一个 FIN （SEQ=y）标志的数据包==>客户端，请求客户端关闭连接。
4. 客户端发送 ACK (SEQ=y+1)标志的数据包==>服务端，服务端收到。客户端等待 **2MSL** 后依然没有收到回复，就证明服务端已正常关闭，随后，客户端也可以关闭连接了。
   **只要四次挥手没有结束，客户端和服务端就可以继续传输数据！**
### 为什么要四次挥手？
TCP是全双工通信，可以双向传输数据。任何一方都可以在数据传送结束后发出连接释放的通知，待对方确认后进入半关闭状态。当另一方也没有数据再发送的时候，则发出连接释放通知，对方确认后就完全关闭了 TCP 连接。

### 为什么不能把服务器发送的 ACK 和 FIN 合并起来，变成三次挥手？
因为==服务器收到客户端断开连接的请求时，可能还有一些数据没有发完==，这时先回复 ACK，表示接收到了断开连接的请求。等到数据发完之后再发 FIN，断开服务器到客户端的数据传送。

### 如果第二次挥手时服务器的 ACK 没有送达客户端，会怎样？
客户端没有收到 ACK 确认，会重新发送 FIN 请求。

### 为什么第四次挥手客户端需要等待 ==2*MSL（报文段最长寿命）==时间后才进入 CLOSED 状态？
第四次挥手时，客户端发送给服务器的 ACK 有可能丢失，如果服务端因为某些原因而没有收到 ACK 的话，服务端就会重发 FIN，如果客户端在 2*MSL 的时间内收到了 FIN，就会重新发送 ACK 并再次等待 2MSL，防止 Server 没有收到 ACK 而不断重发 FIN。

> **MSL(Maximum Segment Lifetime)** : 一个片段在网络中最大的存活时间，2MSL 就是一个发送和一个回复所需的最大时间。如果直到 2MSL，Client 都没有再次收到 FIN，那么 Client 推断 ACK 已经被成功接收，则结束 TCP 连接。



## 滑动窗口

- 发送窗口
  - 维护一个发送窗口，根据接受方回馈的信息来确定发送窗口的大小。
- 接收窗口
  - 维护一个接收窗口，将接收窗口的大小信息包含在ACK消息中发送给对方，通知可以发送的数据量
- 例子
  - 现有1G数据需要发送
  - 发送方发送100kb，接收方返回了窗口大小100kb
  - 发送方发送300kb，接收方返回了窗口大小300kb
  - 发送方发送500kb，接收方返回了窗口大小400kb
  - 此时表明了接收方【能接受的最大窗口为400kb】



滑动窗口可以自适应的调整数据船传输速率，根据【网络条件】和【接收方的处理能力】动态调整。

可以提高数据传输的效率，避免网络拥塞和丢包



## 拥塞窗口

避免发【发送方】的数据填满整个网络，定义了拥塞窗口`cwnd`，发送窗口(`swnd`) = min(`cnwd`,`rwnd`)

拥塞窗口 `cwnd` 变化的规则：

- 只要网络中没有出现拥塞， `cwnd` 就会增大
- 出现了拥塞 `cwnd` 减小

在【发送方】没有在规定时间内接受到 ACK 报文应答，也就是出现了【超时重传】，就会认为网络出现了拥塞。



**拥塞控制算法**

- 慢启动

  - 逐渐提高发送数据包的量(100kb,200kb......)
  - 当发送方<font color=blue>每收到一个 ACK，`cwnd`的大小就会加一</font>
    - 连接建立完成后，一开始初始化 `cwnd = 1`，表示可以传一个 `MSS` 大小的数据。
    - 当收到一个 ACK 确认应答后，cwnd 增加 1，于是一次能够发送 2 个。当收到 2 个的 ACK 确认应答后， cwnd 增加 2，于是就可以比之前多发 2 个，所以这一次能够发送 4 个，呈指数级增加
  - 当 `cwnd`达到慢启动门限(slow start threshold，一般65535B)时，使用【拥塞避免】算法

- 拥塞避免

  - 当发送方<font color=blue>每收到一个ACK，`cwnd`增加1/cwnd</font>
  - 增长到一定大小后出现丢包现象，此时对丢失的数据包进行重传，进入【拥塞发生】算法

- 拥塞发生

     重传机制主要有两种

  - 超时重传
    - `ssthresh`设置为`cwnd/2`
    - `cwnd`重置为初始值
    - 重新开始慢启动，落差大导致网络卡顿
    - ![截屏2023-05-31 下午4.37.34](/Users/huangminzhi/Library/Application Support/typora-user-images/截屏2023-05-31 下午4.37.34.png)
  - 快速重传
    - 当接收方发现丢了一个中间包的时候，发送三次前一个包的 `ACK`，于是发送端就会快速重传
    - `cwnd = cwnd / 2`
    - `ssthresh = cwnd`
    - 进入【快速恢复】算法

- 快速恢复

  - 拥塞窗口 `cwnd = ssthresh + 3`
  - 重传丢失的数据包；
  - 如果再收到重复的 ACK，那么 cwnd 增加 1；
  - 如果收到新数据的 ACK 后，把 cwnd 设置为第一步中的 ssthresh 的值，原因是该 ACK 确认了新的数据，说明从 duplicated ACK 时的数据都已收到，该恢复过程已经结束，可以回到恢复之前的状态了，也即再次进入拥塞避免状态；
  - ![截屏2023-05-31 下午4.39.02](/Users/huangminzhi/Library/Application Support/typora-user-images/截屏2023-05-31 下午4.39.02.png)



# 状态码

| 1**     | 信息，服务器收到请求，需要请求者继续执行操作       |
| ------- | -------------------------------------------------- |
| **2**** | **成功，操作被成功接收并处理**                     |
| **3**** | **重定向，需要进一步的操作以完成请求**             |
| **4**** | **客户端错误，请求包含语法错误或无法完成请求**     |
| **5**** | **服务器错误，服务器在处理请求的过程中发生了错误** |

| 状态码  | 状态码英文名称                  | 中文描述                                                     |
| :------ | :------------------------------ | :----------------------------------------------------------- |
| 100     | Continue                        | 继续。客户端应继续其请求                                     |
| 101     | Switching Protocols             | 切换协议。服务器根据客户端的请求切换协议。只能切换到更高级的协议，例如，切换到HTTP的新版本协议 |
|         |                                 |                                                              |
| **200** | **OK**                          | **请求成功。一般用于GET与POST请求**                          |
| 201     | Created                         | 已创建。成功请求并创建了新的资源                             |
| 202     | Accepted                        | 已接受。已经接受请求，但未处理完成                           |
| 203     | Non-Authoritative Information   | 非授权信息。请求成功。但返回的meta信息不在原始的服务器，而是一个副本 |
| 204     | No Content                      | 无内容。服务器成功处理，但未返回内容。在未更新网页的情况下，可确保浏览器继续显示当前文档 |
| 205     | Reset Content                   | 重置内容。服务器处理成功，用户终端（例如：浏览器）应重置文档视图。可通过此返回码清除浏览器的表单域 |
| 206     | Partial Content                 | 部分内容。服务器成功处理了部分GET请求                        |
|         |                                 |                                                              |
| 300     | Multiple Choices                | 多种选择。请求的资源可包括多个位置，相应可返回一个资源特征与地址的列表用于用户终端（例如：浏览器）选择 |
| **301** | **Moved Permanently**           | **永久移动。请求的资源已被永久的移动到新URI，返回信息会包括新的URI，浏览器会自动定向到新URI。今后任何新的请求都应使用新的URI代替** |
| 302     | Found                           | 临时移动。与301类似。但资源只是临时被移动。客户端应继续使用原有URI |
| 303     | See Other                       | 查看其它地址。与301类似。使用GET和POST请求查看               |
| 304     | Not Modified                    | 未修改。所请求的资源未修改，服务器返回此状态码时，不会返回任何资源。客户端通常会缓存访问过的资源，通过提供一个头信息指出客户端希望只返回在指定日期之后修改的资源 |
| **305** | **Use Proxy**                   | **使用代理。所请求的资源必须通过代理访问**                   |
| 306     | Unused                          | 已经被废弃的HTTP状态码                                       |
| 307     | Temporary Redirect              | 临时重定向。与302类似。使用GET请求重定向                     |
|         |                                 |                                                              |
| **400** | **Bad Request**                 | **客户端请求的语法错误，服务器无法理解**                     |
| **401** | **Unauthorized**                | **请求要求用户的身份认证**                                   |
| 402     | Payment Required                | 保留，将来使用                                               |
| **403** | **Forbidden**                   | **服务器理解请求客户端的请求，但是拒绝执行此请求**           |
| **404** | **Not Found**                   | **服务器无法根据客户端的请求找到资源（网页）。通过此代码，网站设计人员可设置"您所请求的资源无法找到"的个性页面** |
| **405** | **Method Not Allowed**          | **客户端请求中的方法被禁止**                                 |
| 406     | Not Acceptable                  | 服务器无法根据客户端请求的内容特性完成请求                   |
| 407     | Proxy Authentication Required   | 请求要求代理的身份认证，与401类似，但请求者应当使用代理进行授权 |
| 408     | Request Time-out                | 服务器等待客户端发送的请求时间过长，超时                     |
| 409     | Conflict                        | 服务器完成客户端的 PUT 请求时可能返回此代码，服务器处理请求时发生了冲突 |
| 410     | Gone                            | 客户端请求的资源已经不存在。410不同于404，如果资源以前有现在被永久删除了可使用410代码，网站设计人员可通过301代码指定资源的新位置 |
| 411     | Length Required                 | 服务器无法处理客户端发送的不带Content-Length的请求信息       |
| 412     | Precondition Failed             | 客户端请求信息的先决条件错误                                 |
| 413     | Request Entity Too Large        | 由于请求的实体过大，服务器无法处理，因此拒绝请求。为防止客户端的连续请求，服务器可能会关闭连接。如果只是服务器暂时无法处理，则会包含一个Retry-After的响应信息 |
| 414     | Request-URI Too Large           | 请求的URI过长（URI通常为网址），服务器无法处理               |
| 415     | Unsupported Media Type          | 服务器无法处理请求附带的媒体格式                             |
| 416     | Requested range not satisfiable | 客户端请求的范围无效                                         |
| 417     | Expectation Failed              | 服务器无法满足Expect的请求头信息                             |
|         |                                 |                                                              |
| **500** | **Internal Server Error**       | **服务器内部错误，无法完成请求**                             |
| **501** | **Not Implemented**             | **服务器不支持请求的功能，无法完成请求**                     |
| **502** | **Bad Gateway**                 | **作为网关或者代理工作的服务器尝试执行请求时，从远程服务器接收到了一个无效的响应** |
| **503** | **Service Unavailable**         | **由于超载或系统维护，服务器暂时的无法处理客户端的请求。延时的长度可包含在服务器的Retry-After头信息中** |
| **504** | **Gateway Time-out**            | **充当网关或代理的服务器，未及时从远端服务器获取请求**       |
| **505** | **HTTP Version not supported**  | **服务器不支持请求的HTTP协议的版本，无法完成处理**           |

